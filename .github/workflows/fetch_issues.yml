name: Fetch Issue Details

on:
  schedule:
    - cron: '*/10 * * * *'  # Läuft alle 10 Minuten
  workflow_dispatch:

jobs:
  fetch_issue_details:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Issue Details from GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.PAGE_GITHUB }}
        run: |
          echo "==== Sende API-Anfrage ===="
          curl -X POST https://api.github.com/graphql \
               -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Content-Type: application/json" \
               -d @- <<EOF | tee response.json
          {
            "query": "query GetIssueDetails(\$owner: String!, \$repo: String!, \$issueNumber: Int!) {
              repository(owner: \$owner, name: \$repo) {
                issue(number: \$issueNumber) {
                  title
                  number
                  url
                  state
                  createdAt
                  updatedAt
                  closedAt
                  author {
                    login
                    avatarUrl
                  }
                  assignees(first: 5) {
                    nodes {
                      login
                      avatarUrl
                    }
                  }
                  labels(first: 10) {
                    nodes {
                      name
                      color
                    }
                  }
                  milestone {
                    title
                    dueOn
                  }
                  projectItems(first: 5) {
                    nodes {
                      fieldValues(first: 10) {
                        nodes {
                          __typename
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            field {
                              ... on ProjectV2FieldCommon {
                                name
                              }
                            }
                          }
                          ... on ProjectV2ItemFieldTextValue {
                            text
                            field {
                              ... on ProjectV2FieldCommon {
                                name
                              }
                            }
                          }
                          ... on ProjectV2ItemFieldDateValue {
                            date
                            field {
                              ... on ProjectV2FieldCommon {
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }",
            "variables": {
              "owner": "twodarkk",
              "repo": "streamercards",
              "issueNumber": 29
            }
          }
          EOF

          echo "==== API-Response ausgeben ===="
          cat response.json

      - name: Process API Response and Create issues.json
        run: |
          jq 'if .data.repository.issues.nodes then 
          .data.repository.issues.nodes | map({
            title: .title,
            number: .number,
            url: .url,
            state: .state,
            created_at: .createdAt,
            updated_at: .updatedAt,
            author: {
              login: .author.login,
              avatar_url: .author.avatarUrl
            },
            assignees: (if .assignees.nodes | length > 0 
                        then [.assignees.nodes[] | { login: .login, avatar_url: .avatarUrl }]
                        else [] end),
            labels: (if .labels.nodes | length > 0 
                     then [.labels.nodes[] | { name: .name, color: .color }]
                     else [] end),
            milestone: (if .milestone != null 
                        then { title: .milestone.title, due_on: .milestone.dueOn }
                        else null end),
            status: (if (.projectItems.nodes[].fieldValues.nodes[] | select(.field.name == "Status") | .name)? 
                     then .projectItems.nodes[].fieldValues.nodes[] | select(.field.name == "Status") | .name 
                     else null end),
            priority: (if (.projectItems.nodes[].fieldValues.nodes[] | select(.field.name == "Priorität") | .name)? 
                       then .projectItems.nodes[].fieldValues.nodes[] | select(.field.name == "Priorität") | .name 
                       else null end),
            start_date: (if (.projectItems.nodes[].fieldValues.nodes[] | select(.field.name == "Start-Datum") | .date)? 
                         then .projectItems.nodes[].fieldValues.nodes[] | select(.field.name == "Start-Datum") | .date 
                         else null end)
          }) 
          else [] end' response.json > issues.json

      
          echo "==== Generierte issues.json ===="
          cat issues.json



      - name: Commit and Push Issues Data
        run: |
          if [ -s issues.json ]; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git add issues.json
            git commit -m "Updated issue details JSON" || echo "No changes to commit"
            git push
          else
            echo "issues.json ist leer, nichts zu committen."
          fi
